<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<!-- 모바일에서 사이트접속을 위한 반응형 웹 선언-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>메인 페이지</title>
<!-- jQuery Setting -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- js Setting -->
<!-- Common -->
<script src="/js/common/jwt_token_refresh/jwt_auth.js"></script>
<script src="/js/common/member/member_signin_signup_button.js"></script>
<script src="/js/common/member/member_login_or_logout.js"></script>
<script src="/js/common/board/board.js"></script>
<script src="/js/common/visitor/visitor.js"></script>
<!-- Common -->

<!-- CSS Setting Start -->
<link rel="stylesheet" href="css/common/common_header.css">
<link rel="stylesheet" href="css/main/main_body.css">
<link rel="stylesheet" href="css/common/common_footer.css">
<!-- main.css Setting End-->
</head>
<body>
	<!-- 헤더 영역 -->
	<header id="header">
		<!-- 첫 번째 줄 -->
		<div class="header-top">
			<div id="logo">
    			<a href="/">Log</a>
			</div>
			<!-- 오른쪽 사용자 메뉴 -->
			<div id="user-actions">
				<button id="login-btn">로그인</button>
				<button id="register-btn">회원가입</button>
			</div>
		</div>

		<nav id="board-tabs">
			<ul id="parent-boards">
			<!-- 게시판 영역  -->
			</ul>
		</nav>
	</header>
	<!-- 메인 바디 영역(메인 인기 게시글) -->
	<main>
		<section id="popular-posts">
			<h2>메인 인기 게시글</h2>
			<ul id = "popular-posts-container">
				  <!-- jQuery로 게시글 추가 -->
			</ul>
			<!-- 페이징 버튼 영역 -->
    		<div id="pagination-container">
        		<button id="first-page">처음</button>
        		<button id="jump-backward">&lt;&lt;</button>
        		<button id="prev-page">이전</button>
        		<span id="page-buttons"><!-- 페이지 번호 버튼 생성 --></span>
        		<button id="next-page">다음</button>
        		<button id="jump-forward">&gt;&gt;</button>
        		<button id="last-page">마지막</button>
    		</div>
		</section>
	</main>
	<!-- 푸터 영역 -->
	<footer id="main-footer">
		<div class="footer-container">
			<!-- 접속자 영역 -->
			<div class="footer-stats">
				<span>오늘 접속자: <strong id="today-visitors">0</strong></span>
				<span>한 달 접속자: <strong id="month-visitors">0</strong></span>
			</div>
        	<!-- 중앙: 검색창 -->
        	<div class="footer-search">
        		<select id="searchType">
        			<option value="keyword">제목/본문</option>
        			<option value="author">작성자</option>
        		</select>
            	<input type="text" id="searchInput" placeholder="검색어 입력..." />
            	<button class="search-btn">🔍</button>
        	</div>
        	    <!-- 오른쪽: 균형용 스페이서 -->
    		<div class="footer-spacer"></div>
    	</div>
	</footer>
</body>
</html>

<script>

	//*************************************************** 변수 START ***************************************************//
	
	var popular_posts_container = $("#popular-posts-container");
	
	var currentPage = 0; // 현재 페이지
	var totalPages = 0;  // 총 페이지
	var lastPage = 0;     // 마지막 페이지
	var currentMode = 'popular'; // 'popular' | 'search'
	var currentKeyword = '';   // 검색어 저장
	var currentSearchType = 'keyword'; // 검색 타입
	
	//*************************************************** 변수 End ***************************************************//

	//*************************************************** 페이지 초기화  Start ***************************************************//

	/* Cookie API 호출 */
	getCookie();

	/* main API 호출 */
	getMain();

	/* 검색 API 호출 (바텀) */
	keywordSearch();
	


	//*************************************************** 페이지 초기화  Start ***************************************************//

	//*************************************************** Function START ***************************************************//



	
	function keywordSearch() {
		// 검색 버튼 클릭 이벤트
		$(".search-btn").click(function() {
    		executeSearch(0); // 검색 시 항상 1페이지부터
		});

		// Enter 키 입력 이벤트
		$(".footer-search input").on("keydown",function(e) {
			if(e.key === "Enter") {
				executeSearch(0);
			}
		})
	}

	function renderPosts(posts) {
	    var container = $("#popular-posts-container");
	    container.empty();
	    posts.forEach(function(post) {
	    	console.log("index renderPosts posts.thumbnailImageUrl : " + posts.thumbnailImageUrl);
	        var thumbnailHtml = '';
	        if (post.thumbnailImageUrl && post.thumbnailImageUrl.trim() !== '') {
	            thumbnailHtml = `<img src="${post.thumbnailImageUrl}" alt="썸네일" class="post-thumbnail">`;
	        }

	        var postCard =`
	        				<li class = "post-card">
	        					<a href="/posts/${post.postId}" class ="post-link">
	        						${thumbnailHtml}
	        						<div class="post-info">
	        							<h3 class ="post-title">${post.title}</h3>
	        							<p class = "post-meta">
	        								작성자: ${post.userNickname} | 좋아요: ${post.reactionCount} | 댓글: ${post.commentCount} <br>
	        								게시판: ${post.boardName} | 작성일자: ${post.createdAt}
	        							</p>
	        						</div>
	        					</a>
	        				</li>
				          `;

	        container.append(postCard);
	    });
	}

	//*************************************************** Function START ***************************************************//

	//*************************************************** 페이징 START ***************************************************//

	function renderPagination(data) {
	    currentPage = data.pageNumber;
	    totalPages = data.totalPages;
	    lastPage = totalPages - 1;
	
	    const pageButtonsContainer = $("#page-buttons");
	    pageButtonsContainer.empty();
	
	    if (totalPages === 0) {
	        // 페이지가 없으면 모든 버튼 비활성화
	        $("#pagination-container button").prop("disabled", true);
	        return;
	    }
	
	    // 1) 페이지 번호 버튼
	    for (let i = 0; i < totalPages; i++) {
	        let btn = $(`<button>${i + 1}</button>`);
	        if (i === currentPage) btn.prop("disabled", true);
	        btn.click(() => {
	            if(currentMode === 'popular') {
	                getMain(i);
	            } else {
	                executeSearch(i);
	            }
	        });
	        pageButtonsContainer.append(btn);
	    }
	
	    // 이전 버튼
	    $("#prev-page").prop("disabled", !data.hasPrevious).off("click").click(() => {
	        if(data.hasPrevious) {
	            if(currentMode === 'popular') getMain(currentPage - 1);
	            else executeSearch(currentPage - 1);
	        }
	    });

	    // 다음 버튼
	    $("#next-page").prop("disabled", !data.hasNext).off("click").click(() => {
	        if(data.hasNext) {
	            if(currentMode === 'popular') getMain(currentPage + 1);
	            else executeSearch(currentPage + 1);
	        }
	    });
	
	    // 3) 처음/마지막 페이지
	    $("#first-page").prop("disabled", !data.hasFirst).off("click").click(() => {
	        if(data.hasFirst) {
	            if(currentMode === 'popular') getMain(0);
	            else executeSearch(0);
	        }
	    });
	
	    $("#last-page").prop("disabled", !data.hasLast).off("click").click(() => {
	        if(data.hasLast) {
	            if(currentMode === 'popular') getMain(lastPage);
	            else executeSearch(lastPage);
	        }
	    });
	
	    // 4) 점프 뒤로/앞으로 (10페이지 단위)
	    $("#jump-backward").prop("disabled", data.jumpBackwardPage == null || data.jumpBackwardPage === currentPage)
	                        .off("click").click(() => {
	        if(data.jumpBackwardPage != null && data.jumpBackwardPage !== currentPage) {
	            if(currentMode === 'popular') getMain(data.jumpBackwardPage);
	            else executeSearch(data.jumpBackwardPage);
	        }
	    });
	
	    $("#jump-forward").prop("disabled", data.jumpForwardPage == null || data.jumpForwardPage === currentPage)
	                        .off("click").click(() => {
	        if(data.jumpForwardPage != null && data.jumpForwardPage !== currentPage) {
	            if(currentMode === 'popular') getMain(data.jumpForwardPage);
	            else executeSearch(data.jumpForwardPage);
	        }
	    });
	}
	
	//*************************************************** 페이징 End ***************************************************//

	//*************************************************** API START ***************************************************//

	// 메인 인기글 API
	function getMain(page = 0) {
		currentMode = 'popular';
	
		$.ajax({
			url : `/main/popular-posts?page=${page}`, // 메인 컨트롤러 API
			method : 'GET',				// 메인 컨트롤러 HTTP 프로토콜
			success : function (data) {
	
				/* 기존 내용 제거 */
				popular_posts_container.empty();
	
				var mainDataLength = data.posts.length;
	
				if(mainDataLength == 0) {
					popular_posts_container.append(`
									 				<li class="no-posts"> 
							         					인기 게시글이 없습니다. 
							         				</li>
							         			  `)
				} else {
					renderPosts(data.posts || []);
					renderPagination(data);
					currentPage = page;
				}
			},
			error: function(xhr) {
			    if(popular_posts_container.length) { // DOM 존재 확인
			        popular_posts_container.empty(); // 기존 내용 제거
			        popular_posts_container.append(`
			            							<li class="no-posts"> 
			                							인기 게시글이 없습니다. 
			            							</li>
			        							  `);
			    }
			    alert(xhr.responseText || "");
			}
		});
	}

	function executeSearch(page = 0) {
		var keyword  = $("#searchInput").val().trim(); //keyword or author
		var type = $("#searchType").val();

		// 검색어를 명시하지 않을시
		if(!keyword) {
			alert("검색어를 입력하세요.");
			return;
		}

	    currentMode = 'search';
	    currentKeyword = keyword;
	    currentSearchType = type;

		var url = "";

        if (type === "keyword") {
            // 키워드 검색
        	url = `/posts/search?keyword=${encodeURIComponent(keyword)}&page=${page}`;
        } else if (type === "author") {
            // 작성자 검색
        	url = `/posts/author/${encodeURIComponent(keyword)}?page=${page}`;
        }

 
		$.ajax({
			url : url,
			method : "GET",
			success: function(data) {

	            // 제목 변경: 검색 결과일 경우
	            $("#popular-posts h2").text(`검색 결과: "${keyword}"`);

				// 메인 인기글 삭제
				popular_posts_container.empty();
				
				if(data.posts && data.posts.length > 0) {
					renderPosts(data.posts || []);
					renderPagination(data);
					currentPage = page;
				}else {
					popular_posts_container.append(`
													<li class= "no-posts">
														검색 결과가 없습니다.
													</li>
												  `)
					$("#pagination-container button").prop("disabled", true);
				}
				
			},
			error: function(xhr) {
			    if(popular_posts_container.length) { // DOM 존재 확인
			        popular_posts_container.empty(); // 기존 내용 제거
			        popular_posts_container.append(`
			            							<li class="no-posts"> 
			                							검색 결과가 없습니다. 
			            							</li>
			        							  `);
			    }
			    alert(xhr.responseText || "");
			}
		})
	}

	//*************************************************** API End ***************************************************//

</script>