<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<!-- ëª¨ë°”ì¼ì—ì„œ ì‚¬ì´íŠ¸ì ‘ì†ì„ ìœ„í•œ ë°˜ì‘í˜• ì›¹ ì„ ì–¸-->
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ë©”ì¸ í˜ì´ì§€</title>
<!-- jQuery Setting -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- js Setting -->
<!-- Common -->
<script src="/js/common/jwt_token_refresh/jwt_auth.js"></script>
<script src="/js/common/member/member_signin_signup_button.js"></script>
<script src="/js/common/member/member_login_or_logout.js"></script>
<script src="/js/common/board/board.js"></script>
<script src="/js/common/visitor/visitor.js"></script>
<!-- Common -->

<!-- CSS Setting Start -->
<link rel="stylesheet" href="css/common/common_header.css">
<link rel="stylesheet" href="css/main/main_body.css">
<link rel="stylesheet" href="css/common/common_footer.css">
<!-- main.css Setting End-->
</head>
<body>
	<!-- í—¤ë” ì˜ì—­ -->
	<header id="header">
		<!-- ì²« ë²ˆì§¸ ì¤„ -->
		<div class="header-top">
			<div id="logo">
    			<a href="/">Log</a>
			</div>
			<!-- ì˜¤ë¥¸ìª½ ì‚¬ìš©ì ë©”ë‰´ -->
			<div id="user-actions">
				<button id="login-btn">ë¡œê·¸ì¸</button>
				<button id="register-btn">íšŒì›ê°€ì…</button>
			</div>
		</div>

		<nav id="board-tabs">
			<ul id="parent-boards">
			<!-- ê²Œì‹œíŒ ì˜ì—­  -->
			</ul>
		</nav>
	</header>
	<!-- ë©”ì¸ ë°”ë”” ì˜ì—­(ë©”ì¸ ì¸ê¸° ê²Œì‹œê¸€) -->
	<main>
		<section id="popular-posts">
			<h2>ë©”ì¸ ì¸ê¸° ê²Œì‹œê¸€</h2>
			<ul id = "popular-posts-container">
				  <!-- jQueryë¡œ ê²Œì‹œê¸€ ì¶”ê°€ -->
			</ul>
			<!-- í˜ì´ì§• ë²„íŠ¼ ì˜ì—­ -->
    		<div id="pagination-container">
        		<button id="first-page">ì²˜ìŒ</button>
        		<button id="jump-backward">&lt;&lt;</button>
        		<button id="prev-page">ì´ì „</button>
        		<span id="page-buttons"><!-- í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼ ìƒì„± --></span>
        		<button id="next-page">ë‹¤ìŒ</button>
        		<button id="jump-forward">&gt;&gt;</button>
        		<button id="last-page">ë§ˆì§€ë§‰</button>
    		</div>
		</section>
	</main>
	<!-- í‘¸í„° ì˜ì—­ -->
	<footer id="main-footer">
		<div class="footer-container">
			<!-- ì ‘ì†ì ì˜ì—­ -->
			<div class="footer-stats">
				<span>ì˜¤ëŠ˜ ì ‘ì†ì: <strong id="today-visitors">0</strong></span>
				<span>í•œ ë‹¬ ì ‘ì†ì: <strong id="month-visitors">0</strong></span>
			</div>
        	<!-- ì¤‘ì•™: ê²€ìƒ‰ì°½ -->
        	<div class="footer-search">
        		<select id="searchType">
        			<option value="keyword">ì œëª©/ë³¸ë¬¸</option>
        			<option value="author">ì‘ì„±ì</option>
        		</select>
            	<input type="text" id="searchInput" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." />
            	<button class="search-btn">ğŸ”</button>
        	</div>
        	    <!-- ì˜¤ë¥¸ìª½: ê· í˜•ìš© ìŠ¤í˜ì´ì„œ -->
    		<div class="footer-spacer"></div>
    	</div>
	</footer>
</body>
</html>

<script>

	//*************************************************** ë³€ìˆ˜ START ***************************************************//
	
	var popular_posts_container = $("#popular-posts-container");
	
	var currentPage = 0; // í˜„ì¬ í˜ì´ì§€
	var totalPages = 0;  // ì´ í˜ì´ì§€
	var lastPage = 0;     // ë§ˆì§€ë§‰ í˜ì´ì§€
	var currentMode = 'popular'; // 'popular' | 'search'
	var currentKeyword = '';   // ê²€ìƒ‰ì–´ ì €ì¥
	var currentSearchType = 'keyword'; // ê²€ìƒ‰ íƒ€ì…
	
	//*************************************************** ë³€ìˆ˜ End ***************************************************//

	//*************************************************** í˜ì´ì§€ ì´ˆê¸°í™”  Start ***************************************************//

	/* Cookie API í˜¸ì¶œ */
	getCookie();

	/* main API í˜¸ì¶œ */
	getMain();

	/* ê²€ìƒ‰ API í˜¸ì¶œ (ë°”í…€) */
	keywordSearch();
	


	//*************************************************** í˜ì´ì§€ ì´ˆê¸°í™”  Start ***************************************************//

	//*************************************************** Function START ***************************************************//



	
	function keywordSearch() {
		// ê²€ìƒ‰ ë²„íŠ¼ í´ë¦­ ì´ë²¤íŠ¸
		$(".search-btn").click(function() {
    		executeSearch(0); // ê²€ìƒ‰ ì‹œ í•­ìƒ 1í˜ì´ì§€ë¶€í„°
		});

		// Enter í‚¤ ì…ë ¥ ì´ë²¤íŠ¸
		$(".footer-search input").on("keydown",function(e) {
			if(e.key === "Enter") {
				executeSearch(0);
			}
		})
	}

	function renderPosts(posts) {
	    var container = $("#popular-posts-container");
	    container.empty();
	    posts.forEach(function(post) {
	    	console.log("index renderPosts posts.thumbnailImageUrl : " + posts.thumbnailImageUrl);
	        var thumbnailHtml = '';
	        if (post.thumbnailImageUrl && post.thumbnailImageUrl.trim() !== '') {
	            thumbnailHtml = `<img src="${post.thumbnailImageUrl}" alt="ì¸ë„¤ì¼" class="post-thumbnail">`;
	        }

	        var postCard =`
	        				<li class = "post-card">
	        					<a href="/posts/${post.postId}" class ="post-link">
	        						${thumbnailHtml}
	        						<div class="post-info">
	        							<h3 class ="post-title">${post.title}</h3>
	        							<p class = "post-meta">
	        								ì‘ì„±ì: ${post.userNickname} | ì¢‹ì•„ìš”: ${post.reactionCount} | ëŒ“ê¸€: ${post.commentCount} <br>
	        								ê²Œì‹œíŒ: ${post.boardName} | ì‘ì„±ì¼ì: ${post.createdAt}
	        							</p>
	        						</div>
	        					</a>
	        				</li>
				          `;

	        container.append(postCard);
	    });
	}

	//*************************************************** Function START ***************************************************//

	//*************************************************** í˜ì´ì§• START ***************************************************//

	function renderPagination(data) {
	    currentPage = data.pageNumber;
	    totalPages = data.totalPages;
	    lastPage = totalPages - 1;
	
	    const pageButtonsContainer = $("#page-buttons");
	    pageButtonsContainer.empty();
	
	    if (totalPages === 0) {
	        // í˜ì´ì§€ê°€ ì—†ìœ¼ë©´ ëª¨ë“  ë²„íŠ¼ ë¹„í™œì„±í™”
	        $("#pagination-container button").prop("disabled", true);
	        return;
	    }
	
	    // 1) í˜ì´ì§€ ë²ˆí˜¸ ë²„íŠ¼
	    for (let i = 0; i < totalPages; i++) {
	        let btn = $(`<button>${i + 1}</button>`);
	        if (i === currentPage) btn.prop("disabled", true);
	        btn.click(() => {
	            if(currentMode === 'popular') {
	                getMain(i);
	            } else {
	                executeSearch(i);
	            }
	        });
	        pageButtonsContainer.append(btn);
	    }
	
	    // ì´ì „ ë²„íŠ¼
	    $("#prev-page").prop("disabled", !data.hasPrevious).off("click").click(() => {
	        if(data.hasPrevious) {
	            if(currentMode === 'popular') getMain(currentPage - 1);
	            else executeSearch(currentPage - 1);
	        }
	    });

	    // ë‹¤ìŒ ë²„íŠ¼
	    $("#next-page").prop("disabled", !data.hasNext).off("click").click(() => {
	        if(data.hasNext) {
	            if(currentMode === 'popular') getMain(currentPage + 1);
	            else executeSearch(currentPage + 1);
	        }
	    });
	
	    // 3) ì²˜ìŒ/ë§ˆì§€ë§‰ í˜ì´ì§€
	    $("#first-page").prop("disabled", !data.hasFirst).off("click").click(() => {
	        if(data.hasFirst) {
	            if(currentMode === 'popular') getMain(0);
	            else executeSearch(0);
	        }
	    });
	
	    $("#last-page").prop("disabled", !data.hasLast).off("click").click(() => {
	        if(data.hasLast) {
	            if(currentMode === 'popular') getMain(lastPage);
	            else executeSearch(lastPage);
	        }
	    });
	
	    // 4) ì í”„ ë’¤ë¡œ/ì•ìœ¼ë¡œ (10í˜ì´ì§€ ë‹¨ìœ„)
	    $("#jump-backward").prop("disabled", data.jumpBackwardPage == null || data.jumpBackwardPage === currentPage)
	                        .off("click").click(() => {
	        if(data.jumpBackwardPage != null && data.jumpBackwardPage !== currentPage) {
	            if(currentMode === 'popular') getMain(data.jumpBackwardPage);
	            else executeSearch(data.jumpBackwardPage);
	        }
	    });
	
	    $("#jump-forward").prop("disabled", data.jumpForwardPage == null || data.jumpForwardPage === currentPage)
	                        .off("click").click(() => {
	        if(data.jumpForwardPage != null && data.jumpForwardPage !== currentPage) {
	            if(currentMode === 'popular') getMain(data.jumpForwardPage);
	            else executeSearch(data.jumpForwardPage);
	        }
	    });
	}
	
	//*************************************************** í˜ì´ì§• End ***************************************************//

	//*************************************************** API START ***************************************************//

	// ë©”ì¸ ì¸ê¸°ê¸€ API
	function getMain(page = 0) {
		currentMode = 'popular';
	
		$.ajax({
			url : `/main/popular-posts?page=${page}`, // ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ API
			method : 'GET',				// ë©”ì¸ ì»¨íŠ¸ë¡¤ëŸ¬ HTTP í”„ë¡œí† ì½œ
			success : function (data) {
	
				/* ê¸°ì¡´ ë‚´ìš© ì œê±° */
				popular_posts_container.empty();
	
				var mainDataLength = data.posts.length;
	
				if(mainDataLength == 0) {
					popular_posts_container.append(`
									 				<li class="no-posts"> 
							         					ì¸ê¸° ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. 
							         				</li>
							         			  `)
				} else {
					renderPosts(data.posts || []);
					renderPagination(data);
					currentPage = page;
				}
			},
			error: function(xhr) {
			    if(popular_posts_container.length) { // DOM ì¡´ì¬ í™•ì¸
			        popular_posts_container.empty(); // ê¸°ì¡´ ë‚´ìš© ì œê±°
			        popular_posts_container.append(`
			            							<li class="no-posts"> 
			                							ì¸ê¸° ê²Œì‹œê¸€ì´ ì—†ìŠµë‹ˆë‹¤. 
			            							</li>
			        							  `);
			    }
			    alert(xhr.responseText || "");
			}
		});
	}

	function executeSearch(page = 0) {
		var keyword  = $("#searchInput").val().trim(); //keyword or author
		var type = $("#searchType").val();

		// ê²€ìƒ‰ì–´ë¥¼ ëª…ì‹œí•˜ì§€ ì•Šì„ì‹œ
		if(!keyword) {
			alert("ê²€ìƒ‰ì–´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
			return;
		}

	    currentMode = 'search';
	    currentKeyword = keyword;
	    currentSearchType = type;

		var url = "";

        if (type === "keyword") {
            // í‚¤ì›Œë“œ ê²€ìƒ‰
        	url = `/posts/search?keyword=${encodeURIComponent(keyword)}&page=${page}`;
        } else if (type === "author") {
            // ì‘ì„±ì ê²€ìƒ‰
        	url = `/posts/author/${encodeURIComponent(keyword)}?page=${page}`;
        }

 
		$.ajax({
			url : url,
			method : "GET",
			success: function(data) {

	            // ì œëª© ë³€ê²½: ê²€ìƒ‰ ê²°ê³¼ì¼ ê²½ìš°
	            $("#popular-posts h2").text(`ê²€ìƒ‰ ê²°ê³¼: "${keyword}"`);

				// ë©”ì¸ ì¸ê¸°ê¸€ ì‚­ì œ
				popular_posts_container.empty();
				
				if(data.posts && data.posts.length > 0) {
					renderPosts(data.posts || []);
					renderPagination(data);
					currentPage = page;
				}else {
					popular_posts_container.append(`
													<li class= "no-posts">
														ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.
													</li>
												  `)
					$("#pagination-container button").prop("disabled", true);
				}
				
			},
			error: function(xhr) {
			    if(popular_posts_container.length) { // DOM ì¡´ì¬ í™•ì¸
			        popular_posts_container.empty(); // ê¸°ì¡´ ë‚´ìš© ì œê±°
			        popular_posts_container.append(`
			            							<li class="no-posts"> 
			                							ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤. 
			            							</li>
			        							  `);
			    }
			    alert(xhr.responseText || "");
			}
		})
	}

	//*************************************************** API End ***************************************************//

</script>