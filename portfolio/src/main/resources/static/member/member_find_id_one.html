<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>아이디 찾기</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- JS -->
<script src="/js/common/member/member_signin_signup_button.js"></script>
<script src="/js/common/board/board.js"></script>
<script src="/js/common/visitor/visitor.js"></script>
<script src="/js/member/member_validation.js"></script>
<script src="/js/member/get_member.js"></script>
<!-- CSS -->
<link rel="stylesheet" href="/css/common/common_header.css">
<link rel="stylesheet" href="/css/member/member_find_id/member_find_id_one.css">
<link rel="stylesheet" href="/css/member/member_footer.css">
<!-- CSS -->
</head>
<body>
    <!-- 헤더 -->
    <header id="header">
        <div class="header-top">
            <div id="logo">
                <a href="/">Log</a>
            </div>
            <div id="user-actions">
                <button id="login-btn">로그인</button>
                <button id="register-btn">회원가입</button>
            </div>
        </div>
        <nav id="board-tabs">
            <ul id="parent-boards"></ul>
        </nav>
    </header>

    <!-- 메인 바디 -->
    <main>
        <h2>아이디 찾기</h2>
        <form id="find-email-form">
            <!-- 사용자 이름 -->
            <div class="form-item">
            	<h2>사용자 이름</h2>
            </div>
            <div class="form-item">
                <input type="text" id="username" placeholder="예: 홍길동" required>
            </div>

	            <!-- 주민번호 -->
			<div class="form-item">
				<h2>주민번호</h2>
				<div class="flex-group">
				    <input type="text" id="residentNumber1" maxlength="6" placeholder="앞 6자리" required>
				    <span>-</span>
				    <input type="text" id="residentNumber2" maxlength="7" placeholder="뒤 7자리" required>
				</div>
			</div>
            <button type="button" id="nextBtn" disabled>다음</button>
            <div id="error-message" style="color:red; margin-top:10px;"></div>
        </form>
    </main>

    <!-- 푸터 -->
    <footer id="main-footer">
        <div class="footer-stats">
            <span>오늘 접속자: <strong id="today-visitors">0</strong></span>
            <span>한 달 접속자: <strong id="month-visitors">0</strong></span>
        </div>
        <div class="footer-spacer"></div>
    </footer>
</body>

<script>

	//*************************************************** 변수 START ***************************************************//

	var nextBtn = $("#find-email-form button");

	//*************************************************** 변수 START ***************************************************//

    //*************************************************** 페이지 초기화  Start ***************************************************//

    /* 첫 진입시 버튼 비활성화 */
    toggleNextButton();
	/* 뒤로가기/앞으로가기 시에도 버튼 상태 체크 */
    $(window).on('pageshow', function(event) {
        toggleNextButton();
    });

    /* 다음 버튼 활성화 여부 */
  	checkNextButton();
    // 주민번호 숫자 체크 */
  	checkResidentNumberDigit();
    
    find_id_one_api();
    

    //*************************************************** 페이지 초기화  End ***************************************************//

	//*************************************************** Function Start ***************************************************//

    // input 이벤트 등록
    function checkNextButton() {
        $("#username, #residentNumber1, #residentNumber2").on("input", function() {
            toggleNextButton();
        });
    }

    // 입력값 검증 후 버튼 활성/비활성화
    function toggleNextButton() {
        var usernameFilled = checkUserName();
        var residentFilled = checkResidentNumber();
        nextBtn.prop("disabled", !(usernameFilled && residentFilled));
    }

	//*************************************************** Function End ***************************************************//

	//*************************************************** API Start ***************************************************//
	function find_id_one_api() {

	    // 폼 제출 이벤트 ("Enter"key로 폼 제출가능)
	    $("#nextBtn").on("click", function(e) {
			// e.preventDefault() (form 사용시 사용. ) 
	        $("#error-message").text(""); // 초기화

	        if(!checkUserName()) {
	        	$("#username").focus();
	            $("#error-message").text("사용자 이름을 올바르게 입력해주세요.");
	            return;
	        }

	        if (!checkResidentNumber()) {
	        	$("#residentNumber1").focus();
	            $("#error-message").text("주민번호를 올바르게 입력해주세요.");
	            return;
	        }

	        // DTO Request
	        var data = {
	            username: getUserNameValue(),
	            residentNumber: getResidentNumber()
	        };

	        $.ajax({
	            url: "/members/find-email",
	            type: "POST",
	            contentType: "application/json",
	            data: JSON.stringify(data),
	            success: function(res) {
	            	console.log(res);
	            	// sessionStorage("findEmailToken(key)", "TENP_TOKEN(value)") 저장
	                sessionStorage.setItem("findEmailToken", res.token); // 임시 토큰 저장
	                window.location.href = "/find_id_two"; // 2단계 페이지로 이동
	            },
	            error: function(xhr) {
	                $("#error-message").text(xhr.responseText || "서버 오류가 발생했습니다.");
	            }
	        });
	    });
	}
	//*************************************************** API End ***************************************************//
</script>
</html>
