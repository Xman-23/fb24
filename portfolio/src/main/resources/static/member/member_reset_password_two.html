<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>비밀번호 재설정</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- JS -->
<script src="/js/common/member/member_signin_signup_button.js"></script>
<script src="/js/common/board/board.js"></script>
<script src="/js/common/visitor/visitor.js"></script>
<script src="/js/member/member_validation.js"></script>
<!-- CSS -->
<link rel="stylesheet" href="/css/common/common_header.css">
<link rel="stylesheet" href="/css/member/member_reset_password/member_reset_password_two.css">
<link rel="stylesheet" href="/css/member/member_footer.css">
</head>
<body>

    <!-- 헤더 -->
    <header id="header">
        <div class="header-top">
            <div id="logo"><a href="/">Log</a></div>
            <div id="user-actions">
                <button id="login-btn">로그인</button>
                <button id="register-btn">회원가입</button>
            </div>
        </div>
        <nav id="board-tabs">
            <ul id="parent-boards"></ul>
        </nav>
    </header>

	<main>
	    <h2>비밀번호 재설정</h2>
	    <form id="reset-password-form">
	        <!-- 새 비밀번호 -->
	        <div class="form-item">
	            <label for="newPassword">새 비밀번호</label>
	            <input type="password" id="password" placeholder="새 비밀번호 입력" required>
	            <span id="password-valid-feedback" class="feedback"></span>
	        </div>
	
	        <!-- 비밀번호 확인 -->
	        <div class="form-item">
	            <label for="confirmNewPassword">비밀번호 확인</label>
	            <input type="password" id="confirmPassword" placeholder="비밀번호 확인" required>
	            <span id="password-match-feedback" class="feedback"></span>
	        </div>
	
	        <button type="button" id="reset-password-btn" disabled>비밀번호 재설정</button>
	    </form>
	</main>

	<!-- 푸터 -->
    <footer id="main-footer">
        <div class="footer-stats">
            <span>오늘 접속자: <strong id="today-visitors">0</strong></span>
            <span>한 달 접속자: <strong id="month-visitors">0</strong></span>
        </div>
        <div class="footer-spacer"></div>
    </footer>
</body>

<script>

	//*************************************************** 페이지 초기화  Start ***************************************************//

	// 페이지 진입시 버튼 초기화
	toggleResetButton();
	// 버튼 활성화
	checkNextButton();

	// api
	password_reset_api();

	//*************************************************** 페이지 초기화  Start ***************************************************//

	// 버튼 활성화
	function checkNextButton() {
	    $("#password, #confirmPassword")
	    .on("input", function() {
	        checkPasswordValidity(); // 패스워드 유효성 검사
	        checkPasswordMatch();  // 패스워드, 패스워드 확인 유효성 검사
	        toggleResetButton(); // 종합 유효성 검증
	    });
	}

    // 버튼 활성/비활성 토글
    function toggleResetButton() {
    	var passwordValid = checkPasswordValidity() && checkPasswordMatch();
        $("#reset-password-btn").prop("disabled", !(passwordValid));
    }

	//*************************************************** API START ***************************************************//

	// 패스워드 변경 api
	function password_reset_api() {
	    // 버튼 클릭 시 PATCH 요청
	    $("#reset-password-btn").on("click", function() {
	        var  token = sessionStorage.getItem("resetPasswordToken");
	        if(!token) {
	            alert("토큰이 만료되었거나 없습니다. 다시 시도해주세요.");
	            return;
	        }

	        var data = {
	           newPassword: $("#password").val(),
	           confirmNewPassword: $("#confirmPassword").val()
	        };

	        $.ajax({
	            url: "/members/reset-password",
	            type: "PATCH",
	            contentType: "application/json",
	            headers: { "Authorization": "Bearer " + token },
	            data: JSON.stringify(data),
	            success: function(res) {
	                alert(res);
	                window.location.href = "/signin";
	            },
	            error: function(xhr) {
	                alert(xhr.responseText);
	            }
	        });
	    });
	}

</script>
</body>
</html>
