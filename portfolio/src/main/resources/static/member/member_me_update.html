<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>회원정보 변경</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- Common -->
<script src="/js/common/jwt_token_refresh/jwt_auth.js"></script>
<script src="/js/common/member/member_login_or_logout.js"></script>
<script src="/js/common/board/board.js"></script>
<script src="/js/common/visitor/visitor.js"></script>
<script src="/js/member/member_validation.js"></script>
<script src="/js/member/get_member.js"></script>
<!-- Common -->
<!-- CSS -->
<link rel="stylesheet" href="css/common/common_header.css">
<link rel="stylesheet" href="css/member/member_me/member_me_update.css">
<link rel="stylesheet" href="css/member/member_footer.css">
<!-- CSS -->
</head>
<body>
	<!-- 헤더 -->
    <header id="header">
        <div class="header-top">
            <div id="logo">
                <a href="/">Log</a>
            </div>
            <div id="user-actions">
                <button id="login-btn">로그인</button>
                <button id="register-btn">회원가입</button>
            </div>
        </div>
        <nav id="board-tabs">
            <ul id="parent-boards"></ul>
        </nav>
    </header>

    <!-- 메인 바디 -->
	<main>
	    <h2>회원정보 수정</h2>
	    <div id="member-info">
	        <p>사용자 이름: <span id="username"></span></p>
	        <p>닉네임: 
	            <input type="text" id="nickname">
	            <button type="button" id="check-nickname-btn">중복 확인</button>
	            <span id="nickname-feedback"></span>
	        </p>
	        <p>핸드폰 번호: 
	            <input type="text" id="phoneNumber1" maxlength="3"> -
	            <input type="text" id="phoneNumber2" maxlength="4"> -
	            <input type="text" id="phoneNumber3" maxlength="4">
	        </p>
	        <p>주소: <input type="text" id="address"></p>
	        <p>회원 등급: <span id="memberGradeLevel"></span></p>
	        <p>
	            게시글 알림: <input type="checkbox" id="postNotification">
	            댓글 알림: <input type="checkbox" id="commentNotification">
	        </p>
	        <button type="button" id="saveBtn" disabled>저장</button>
	    </div>
	</main>

        <!-- 푸터 -->
    <footer id="main-footer">
        <div class="footer-stats">
            <span>오늘 접속자: <strong id="today-visitors">0</strong></span>
            <span>한 달 접속자: <strong id="month-visitors">0</strong></span>
        </div>
        <div class="footer-spacer"></div>
    </footer>
</body>
</html>

<script>

	//*************************************************** 변수 START ***************************************************//
	// 세션에서 회원정보 가져오기
	var editMemberPrefill = JSON.parse(sessionStorage.getItem("editMemberPrefill"));
	console.log(editMemberPrefill);
	//*************************************************** 변수 End ***************************************************//

	//*************************************************** 페이지 초기화 Start ***************************************************//

	// 토큰 유효성 검증
	token_check();
	// 핸드폰번호 숫자 유효성 검증
	checkPhoneNumberDigit();
	// input 태그 바인딩
	input_binding();
	// checkbox 태그 바인딩
	checkbox_binding();

	nickname_api();
	member_info_update_api();
	//*************************************************** 페이지 초기화 End ***************************************************//

	//*************************************************** Function Start ***************************************************//
	function token_check() {
		if (editMemberPrefill) {
		    $('#username').text(editMemberPrefill.username);
		    $('#nickname').val(editMemberPrefill.nickname);
		    $('#phoneNumber1').val(editMemberPrefill.phoneNumber.slice(0,3));
		    $('#phoneNumber2').val(editMemberPrefill.phoneNumber.slice(3,7));
		    $('#phoneNumber3').val(editMemberPrefill.phoneNumber.slice(7));
		    $('#address').val(editMemberPrefill.address);
		    $('#memberGradeLevel').text(editMemberPrefill.memberGradeLevel);
		    $('#postNotification').prop('checked', editMemberPrefill.postNotificationEnabled);
		    $('#commentNotification').prop('checked', editMemberPrefill.commentNotificationEnabled);
	    }else {
	    	alert("회원정보가 없습니다");
	    	window.location.href = "/";
	    }
	}

	// 이벤트 바인딩
	function input_binding() {
		$("#nickname, #phoneNumber1, #phoneNumber2, #phoneNumber3, #address").on("input", toggleSaveButton);
	}
	function checkbox_binding() {
		$("#postNotification, #commentNotification").on("change", toggleSaveButton);
	}

	// 닉네임 유효성 체크 (변경하지 않았으면 통과)
	function checkNickNameValid() {
		// 기존 닉네임
	    var currentNickname = editMemberPrefill.nickname;
		// 새로운 닉네임
	    var newNickname = $("#nickname").val().trim();
		// 기존 닉네임과 새로운 닉네임이 같다면 그대로 true'
	    if (newNickname === currentNickname) {
	    	return true;
	    }
		// 변경되었다면 중복확인의 결과인,
		// #nickname-feedbac 에서 data-valid 속성가져와 비교하기
	    return $("#nickname-feedback").attr("data-valid") === "true";
	}

	// 닉네임 변경 여부 확인
	function nicknameChanged() {
		// 닉네임 변경 안할시 false, 변경시 true
	    return $("#nickname").val().trim() !== editMemberPrefill.nickname;
	}

	// 핸드폰 번호 변경 여부 확인
	function phoneChanged() {
		// 핸드폰 변경 안할시 false, 변경시 true
	    return getPhoneNumber() !== editMemberPrefill.phoneNumber;
	}

	// 주소 변경 여부 확인
	function addressChanged() {
		// 주소 변경 안할시 false, 변경시 true
	    return $("#address").val().trim() !== editMemberPrefill.address;
	}

	// 저장 버튼 활성화
	function toggleSaveButton() {
	    // 닉네임 유효성 체크 (변경하지 않았으면 통과)
	    var nicknameValid = checkNickNameValid();

	    // 핸드폰 번호 체크
	    var phoneValid = checkPhoneNumber();

	    // 주소 체크
	    var address = $("#address").val().trim();
	    var addressValid = address.length > 0;

	    // 체크박스 변경 여부 체크
	    var postNotificationChanged = $("#postNotification").is(":checked") !== editMemberPrefill.postNotificationEnabled;
	    var commentNotificationChanged = $("#commentNotification").is(":checked") !== editMemberPrefill.commentNotificationEnabled;

	    // 아무 것도 변경되지 않았으면 disabled
	    var somethingChanged = nicknameValid && phoneValid && addressValid &&
	                           (nicknameChanged() || phoneChanged() || addressChanged() || postNotificationChanged || commentNotificationChanged);

	    $("#saveBtn").prop("disabled", !somethingChanged);
	}

	//*************************************************** Function End ***************************************************//

	//*************************************************** API Start ***************************************************//
	// 닉네임 중복 확인 API
	function nickname_api() {
		$("#check-nickname-btn").on("click", function() {
		    var nickname = $("#nickname").val().trim();
		    if (!nickname) {
		    	return alert("닉네임을 입력해주세요.");
		    }

		    $.ajax({
		        url: "/members/check-nickname",
		        type: "GET",
		        data: { nickname: nickname },
		        success: function(res) {
		        	// 닉네임 중복확인
		            $("#nickname-feedback").text(res).css("color", "green").attr("data-valid", "true");
		            toggleSaveButton();
		        },
		        error: function(xhr) {
		        	// 닉네임 중복확인 실패
		            $("#nickname-feedback").text(xhr.responseText).css("color", "red").attr("data-valid", "false");
		            toggleSaveButton();
		        }
		    });
		});
	}

	// 회원정보 변경 API
	function member_info_update_api() {
		// 저장 버튼 클릭
		$("#saveBtn").on("click", function() {
		    if (!checkNickNameValid()) {
		    	return alert("닉네임이 유효하지 않습니다.");
		    }
		    if (!checkPhoneNumber()) {
		    	return alert("핸드폰 번호가 올바르지 않습니다.");
		    }
		    if (!$("#address").val().trim()) {
		    	return alert("주소를 입력해주세요.");
		    }

		    var dto = {
		        nickname: $("#nickname").val().trim(),
		        phoneNumber: getPhoneNumber(),
		        address: $("#address").val().trim(),
		        postNotificationEnabled: $("#postNotification").is(":checked"),
		        commentNotificationEnabled: $("#commentNotification").is(":checked")
		    };

		    ajaxWithToken({
		        url: '/members/me',
		        type: 'PATCH',
		        contentType: 'application/json',
		        data: JSON.stringify(dto),
		        success: function(res) {
		            alert(res);
		            window.location.href = '/member_me';
		        },
		        error: function(xhr) {
		            alert(xhr.responseText || '회원정보 수정에 실패했습니다.');
		        }
		    });
		});
	}
	
	//*************************************************** API End ***************************************************//

</script>