<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>회원정보 조회</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<!-- jQuery -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<!-- jQuery -->
<!-- Common -->
<script src="/js/common/jwt_token_refresh/jwt_auth.js"></script>
<script src="/js/common/member/member_login_or_logout.js"></script>
<script src="/js/common/board/board.js"></script>
<script src="/js/common/visitor/visitor.js"></script>
<!-- Common -->
<!-- CSS -->
<link rel="stylesheet" href="css/common/common_header.css">
<link rel="stylesheet" href="css/member/member_me/member_me.css">
<link rel="stylesheet" href="css/member/member_footer.css">
<!-- CSS -->
</head>
<body>
	<!-- 헤더 -->
    <header id="header">
        <div class="header-top">
            <div id="logo">
                <a href="/">Log</a>
            </div>
            <div id="user-actions">
                <button id="login-btn">로그인</button>
                <button id="register-btn">회원가입</button>
            </div>
        </div>
        <nav id="board-tabs">
            <ul id="parent-boards"></ul>
        </nav>
    </header>
    
    <!-- 메인 바디 -->
	<main>
	    <h2>회원정보</h2>
	    <div id="member-info">
	        <p>사용자 이름: <span id="username"></span></p>
	        <p>닉네임: <span id="nickname"></span></p>
	        <p>핸드폰 번호: <span id="phoneNumber"></span></p>
	        <p>주소: <span id="address"></span></p>
	        <p>회원 등급: <span id="memberGradeLevel"></span></p>
	        <p>게시글 알림: <span id="postNotification"></span></p>
	        <p>댓글 알림: <span id="commentNotification"></span></p>
	    </div>
	    <button type="button" id="update_info_btn">회원정보 변경</button>
		<button type="button" id="withdraw-btn">회원 탈퇴</button>
	</main>

    <!-- 푸터 -->
    <footer id="main-footer">
        <div class="footer-stats">
            <span>오늘 접속자: <strong id="today-visitors">0</strong></span>
            <span>한 달 접속자: <strong id="month-visitors">0</strong></span>
        </div>
        <div class="footer-spacer"></div>
    </footer>
</body>
</html>
<script>

	//*************************************************** 페이지 초기화  Start ***************************************************/
	// 기존 회원정보 조회 API;
	load_member_info_api();

	// 회원정보 변경 페이지 이동
	update_info();
	
	// 회원탈퇴 API
	member_withdraw_api();
	//*************************************************** 페이지 초기화  End ***************************************************/

	//*************************************************** Function  Start ***************************************************/

	function logoutAndRedirect() {
        // 토큰 삭제 등 로그아웃 처리
        sessionStorage.removeItem("accessToken");
        sessionStorage.removeItem("refreshToken");
        window.location.href = "/"; // 메인 페이지 이동
    }

	//*************************************************** Function End***************************************************/

	//*************************************************** API START ***************************************************//

	// 기존 회원정보 조회
	function load_member_info_api() {
	    ajaxWithToken({
	        url: '/members/me',
	        type: 'GET',
	        success: function(res) {
	            $('#username').text(res.username);
	            $('#nickname').text(res.nickname);
	            $('#phoneNumber').text(res.phoneNumber);
	            $('#address').text(res.address);
	            $('#memberGradeLevel').text(res.memberGradeLevel);
	            // 게시글 알림 색상입히기 (활성(notification-active) : 파란색), (비활성(notification-inactive) : 빨간색) 
	            $('#postNotification')
	            	.text(res.postNotificationEnabled ? '활성' : '비활성')
	            	.removeClass('notification-active notification-inactive')
	            	.addClass(res.postNotificationEnabled ? 'notification-active' : 'notification-inactive');
	            $('#commentNotification')
	            	.text(res.commentNotificationEnabled ? '활성' : '비활성')
	            	.removeClass('notification-active notification-inactive')
	            	.addClass(res.commentNotificationEnabled ? 'notification-active' : 'notification-inactive');

	        },
	        error: function(xhr) {
	            $('#member-info').html(`<p style="color:red;">${xhr.responseText || '회원정보를 가져오는데 실패했습니다.'}</p>`);
	        }
	    });
	}

	function update_info() {
		$("#update_info_btn").on('click',function () {
			ajaxWithToken({
				url: '/members/me',
	        	type: 'GET',
	        	success : function(res) {
	        		sessionStorage.setItem("editMemberPrefill",  JSON.stringify(res));
	        		 window.location.href = '/member_me_update';
	        	},
	            error: function (xhr) {
	                alert(xhr.responseText || '회원정보를 불러오지 못했습니다.');
	              }
			})
		})
	}

	function member_withdraw_api() {

	    $("#withdraw-btn").on("click", function() {
	        if (!confirm("정말 탈퇴하시겠습니까? 탈퇴 후 복구가 불가능합니다.")) {
	            return;
	        }

	        // AJAX PATCH 요청
	        ajaxWithToken({
	            url: "/members/me/withdraw",
	            type: "PATCH",
	            success: function(res) {
	                alert(res); // "회원 탈퇴가 정상 처리되었습니다."
	                // 로그아웃 처리 후 메인 페이지 이동
	                logoutAndRedirect();
	            },
	            error: function(xhr) {
	                alert(xhr.responseText || "회원 탈퇴에 실패했습니다.");
	            }
	        });
	    });
	}

	//*************************************************** API START ***************************************************//

</script>